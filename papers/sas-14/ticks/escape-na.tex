\begin{tikzpicture}

  \begin{scope}
    \matrix (m) [na-matrix] {
      \node[na-context]{};
      & \node[na-state]{}; & \node[na-context]{};
      & \node[na-state]{}; & \node[na-context,draw=red!50]{5};
      & \node[na-state]{}; & \node[na-context]{};
      & \node[na-state]{3}; & \node[na-context]{}; \\
    };

    \makehighgroup{m-1-1}{m-1-2}{2}
    \makehighgroup{m-1-3}{m-1-4}{4}
    \makehighgroup[draw=red!50,densely dotted]{m-1-5}{m-1-6}{6}
    \draw[na-edge,->] (m-1-8) .. controls +(115:10mm) and +(30:7mm) .. (n2);
    \draw[na-edge,->] (m-1-8) .. controls +(115:8mm) and +(30:5mm) .. (n4);
    \draw[na-edge,->,draw=red!50,densely dotted] (m-1-8) .. controls +(115:6mm) and +(30:3mm) .. (n6);

%     \makelowgroup[green!20!orange,thin]{m-1-1}{m-1-1}{2}
%     \makelowgroup[green!20!orange,thin]{m-1-3}{m-1-4}{4}
%     \makelowgroup[green!20!orange,thin]{m-1-5}{m-1-6}{6}
%     \draw[na-edge,->,green!20!orange] (m-1-2) .. controls +(-100:5mm) and +(-30:3mm) .. (p2);
%     \draw[na-edge,->,green!20!orange] (m-1-2) .. controls +(-80:5mm) and +(-150:3mm) .. (p4);
%     \draw[na-edge,->,green!20!orange] (m-1-2) .. controls +(-80:8mm) and +(-160:6mm) .. (p6);
  \end{scope}

  \begin{scope}[shift={(0,-1.5)}]
    \matrix (m2) [na-matrix] {
      \node[na-context]{};
      & \node[na-state]{}; & \node[na-context]{};
      & \node[na-state]{}; & \node[na-context,draw=red!50]{5};
      & \node[na-state]{}; & \node[na-context]{};
      & \node[na-state,draw=red!50,fill=red!20]{4}; & \node[na-context]{}; \\
    };

%     \makehighgroup{m2-1-1}{m2-1-2}{2}
%     \makehighgroup{m2-1-3}{m2-1-4}{4}
%     \makehighgroup{m2-1-5}{m2-1-6}{6}
%     \draw[na-edge,->] (m2-1-8) .. controls +(115:10mm) and +(30:7mm) .. (n2);
%     \draw[na-edge,->] (m2-1-8) .. controls +(115:8mm) and +(30:5mm) .. (n4);
%     \draw[na-edge,->] (m2-1-8) .. controls +(115:6mm) and +(30:3mm) .. (n6);

%     \makelowgroup[green!20!orange,thin]{m-1-1}{m-1-1}{2}
%     \makelowgroup[green!20!orange,thin]{m-1-3}{m-1-4}{4}
%     \makelowgroup[green!20!orange,thin]{m-1-5}{m-1-6}{6}
%     \draw[na-edge,->,green!20!orange] (m-1-2) .. controls +(-100:5mm) and +(-30:3mm) .. (p2);
%     \draw[na-edge,->,green!20!orange] (m-1-2) .. controls +(-80:5mm) and +(-150:3mm) .. (p4);
%     \draw[na-edge,->,green!20!orange] (m-1-2) .. controls +(-80:8mm) and +(-160:6mm) .. (p6);
  \end{scope}

  \begin{pgfonlayer}{my background}
    \draw[background rectangle,double=white] ([shift={(-0.5,0.5)}]m.north west) rectangle ([shift={(0.5,-0.5)}]m2.south east);
  \end{pgfonlayer}

  \node[rotate=-90] at (barycentric cs:m-1-8=0.5,m2-1-8=0.5){$\trans$};
  \node[na-looplabel] at ([shift={(0,-0.5)}]m2.south) {Escape};
\end{tikzpicture}
