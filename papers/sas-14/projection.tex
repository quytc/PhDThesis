%
\beginpgfgraphicnamed{projection-funnel}
\begin{tikzpicture}
    \begin{scope}
    \matrix (c) [na-matrix] at (0,1.25){
      |[na-state,path fading=west]|
      & |[na-state]| & |[na-state]|
      & |[na-state]| & |[na-state]|
      & |[na-state]| & |[na-state]|
      & |[na-state]| & |[na-state]|
      & |[na-state]| & |[na-state,path fading=east]| \\
    };

    \matrix (m) [na-matrix] {
      |[na-context,path fading=west]|
      & |[na-state]| & |[na-context]|
      & |[na-state]| & |[na-context]|
      & |[na-state]| & |[na-context]|
      & |[na-state]| & |[na-context,path fading=east]| \\
    };

    %% ---------------------------------------------

    \fill[fill=blue!20,path fading=north]
    (m-1-3.north west) .. controls +(up:7mm) and +(down:6mm) .. (c-1-3.south west) --
    (c-1-5.south east) .. controls +(down:6mm) and +(up:7mm) .. (m-1-3.north east) -- cycle;

    \fill[fill=blue!20,path fading=north]
    (m-1-5.north west) .. controls +(up:7mm) and +(down:6mm) .. (c-1-7.south west) --
    (c-1-7.south east) .. controls +(down:6mm) and +(up:7mm) .. (m-1-5.north east) -- cycle;

    \fill[fill=blue!20,path fading=north]
    (m-1-7.north west) .. controls +(up:7mm) and +(down:6mm) .. (c-1-9.south west) --
    (c-1-9.south east) .. controls +(down:6mm) and +(up:7mm) .. (m-1-7.north east) -- cycle;

    \draw[na-edge,<->,shorten >=2pt,shorten <=5pt] (m-1-2) .. controls +(up:7mm) and +(down:7mm) .. (c-1-2);
    \draw[na-edge,<->,shorten >=2pt,shorten <=2pt] (m-1-4) .. controls +(up:7mm) and +(down:7mm) .. (c-1-6);
    \draw[na-edge,<->,shorten >=2pt,shorten <=2pt] (m-1-6) .. controls +(up:7mm) and +(down:7mm) .. (c-1-8);
    \draw[na-edge,<->,shorten >=2pt,shorten <=5pt] (m-1-8) .. controls +(up:7mm) and +(down:7mm) .. (c-1-10);

    \node[above=0pt of c-1-2,anchor=south,scale=0.5]{${g(i)}$};
    \node[above=0pt of c-1-10,anchor=south,scale=0.5]{${g(i+1)}$};

    %% ---------------------------------------------

    \matrix (m2) [na-matrix] at (0,-1.25) { % at (-0.5,-2) {
      |[na-context,path fading=west]| & |[na-state]| & |[na-context]| & |[na-state]| & |[na-context,path fading=east]| \\
    };

    \fill[fill=blue!20,path fading=north]
    (m2-1-3.north west) .. controls +(up:7mm) and +(down:6mm) .. (m-1-3.south west) --
    (m-1-7.south east) .. controls +(down:6mm) and +(up:7mm) .. (m2-1-3.north east) -- cycle;

    \draw[na-edge,<->,shorten >=2pt,shorten <=2pt] (m2-1-2) .. controls +(up:7mm) and +(down:7mm) .. (m-1-2);
    \draw[na-edge,<->,shorten >=2pt,shorten <=2pt] (m2-1-4) .. controls +(up:7mm) and +(down:7mm) .. (m-1-8);

    \node[above=0pt of m-1-2,anchor=south,scale=0.5]{${h(i)}$};
    \node[above=0pt of m-1-8,anchor=south,scale=0.5]{${h(i+1)}$};
    \node[below=0pt of m2-1-2,anchor=north,scale=0.5]{${i}$};
    \node[below=0pt of m2-1-4,anchor=north,scale=0.5]{${i+1}$};

    \begin{pgfonlayer}{my background}
      \node[fit=(m)(m2)(c)] (bg){}; %
      \draw[background rectangle,double=white]
      ([shift={(-0.3,0.5)}]bg.north west) --
      ([shift={(0.3,0.5)}]bg.north east) --
      ([shift={(0.3,-0.5)}]bg.south east) --
      ([shift={(-0.3,-0.5)}]bg.south west) -- cycle;
    \end{pgfonlayer}

    \node[na-looplabel] at ([shift={(0,-0.5)}]bg.south) {Projection};
  \end{scope}

\end{tikzpicture}
\endpgfgraphicnamed
%
